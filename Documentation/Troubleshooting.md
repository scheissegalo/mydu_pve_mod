# Troubleshooting Guide

## Quick Diagnostic Commands

### 1. Check if Encounters Exist

```bash
curl http://localhost:5480/sector/encounter
```

**Expected:** You should see JSON array with encounter objects. Each should have:

- `id`, `name`, `onLoadScript`, `onSectorEnterScript`
- `territoryId` (should not be null/empty)
- `active: true`

### 2. Check if Sectors Are Generated

```bash
curl http://localhost:5480/sector/instance
```

**Expected:** Array of sector instances. If empty, sectors haven't been generated yet.

**What you'll see:**

- `sector` - Coordinates (x, y, z)
- `onLoadScript` - Script that runs when sector loads
- `onSectorEnterScript` - Script that runs when player enters
- `startedAt` - Null if not activated yet, timestamp if activated
- `expiresAt` - When sector expires

### 3. Check Active Sectors (Where Encounters Triggered)

```bash
curl http://localhost:5480/sector/instance/active
```

**Expected:** Sectors where `startedAt` is set (player entered and encounter spawned).

### 4. Check Available Scripts

```bash
curl http://localhost:5480/script
```

**Expected:** List of all scripts. Should include:

- `spawn-basic-poi`
- `spawn-basic-pirate`
- `expire-sector-default`
- Any scripts from encounters you added

### 5. Check Available Prefabs

```bash
curl http://localhost:5480/prefab
```

**Expected:** List of construct definitions. Should include:

- `basic-poi`
- `basic-pirate`
- Any custom prefabs you added

## Common Issues

### Issue: "I see encounters but no sectors"

**Cause:** Sectors are generated by background workers. They may not have run yet, or there's no faction-territory link.

**Solution:**

1. **Check if default faction-territory exists:**

   ```sql
   -- Connect to your postgres database
   SELECT * FROM mod_faction_territory;
   ```

   If empty, you need to create a faction-territory link. The default faction (id=1) and default territory should exist from migrations.

2. **Create the missing faction-territory link:**

   First, get your territory ID from your encounters:

   ```bash
   curl http://localhost:5480/sector/encounter | jq '.[0].territoryId'
   ```

   Then run this SQL (replace TERRITORY_ID with the value from above):

   ```sql
   INSERT INTO mod_faction_territory (faction_id, territory_id, permanent, active, sector_count)
   VALUES (
       1,  -- Default faction (Pirates)
       'TERRITORY_ID',  -- Your territory ID from encounters
       false,
       true,
       10  -- Number of sectors to generate
   )
   ON CONFLICT DO NOTHING;
   ```

   Or use the provided SQL script: `Documentation/FixMissingFactionTerritory.sql`

3. **Force sector regeneration:**

   ```bash
   curl -X POST http://localhost:5480/sector/instance/expire/force/all
   ```

4. **Check logs for sector generation:**

   ```bash
   docker-compose logs mod_dynamic_encounters | grep -i "sector\|encounter" | tail -50
   ```

5. **Wait a few minutes** - Sector generation happens in background workers that run periodically.

### Issue: "Sectors exist but encounters don't trigger"

**Cause:** Player hasn't entered the sector yet, or sector activation failed.

**Solution:**

1. **Check if sectors are near player:**

   - Sectors spawn at coordinates defined by territory properties
   - Default territory center: (13771471, 7435803, -128971)
   - Default radius: 26,000,000 to 40,000,000 meters

2. **Manually activate a sector:**

   ```bash
   # Get a sector coordinate from /sector/instance
   curl -X POST http://localhost:5480/sector/instance/activate \
     -H "Content-Type: application/json" \
     -d '{"sector": {"x": 13771471, "y": 7435803, "z": -128971}}'
   ```

3. **Check logs for activation:**
   ```bash
   docker-compose logs mod_dynamic_encounters | grep -i "activate\|encounter\|spawn" | tail -50
   ```

### Issue: "Script not found errors"

**Cause:** Scripts are cached in memory. New scripts need a restart.

**Solution:**

```bash
docker-compose restart mod_dynamic_encounters
```

### Issue: "Constructs aren't appearing in game"

**Cause:** Scripts may have failed, or constructs spawned but were deleted.

**Solution:**

1. **Check if script executed successfully:**

   ```bash
   docker-compose logs mod_dynamic_encounters | grep -i "error\|exception\|failed" | tail -50
   ```

2. **Verify prefab exists:**

   ```bash
   curl http://localhost:5480/prefab | jq '.[] | select(.name == "basic-poi")'
   ```

3. **Check if script is correct:**

   ```bash
   curl http://localhost:5480/script | jq '.[] | select(.name == "spawn-basic-poi")'
   ```

4. **Manually test script execution** (if you have access to game admin tools)

## Understanding the Data Flow

### Database Tables

1. **`mod_sector_encounter`** - Encounter templates

   - Defines what CAN spawn
   - Links scripts to territories

2. **`mod_sector_instance`** - Actual spawned sectors

   - Generated from encounters
   - One per sector coordinate
   - Has expiration times

3. **`mod_faction`** - Faction definitions

   - Default: id=1, tag="pirates"

4. **`mod_territory`** - Territory definitions

   - Defines spawn area (center, min/max radius)
   - Default territory created automatically

5. **`mod_faction_territory`** - Links factions to territories
   - Defines which encounters spawn for which faction
   - Needs to exist for sectors to generate

### Background Workers

1. **SectorSpawnerWorker** - Generates sector instances

   - Runs periodically
   - Checks each faction-territory
   - Creates sector instances from encounters

2. **SectorActivationWorker** - Activates sectors when players enter

   - Monitors player positions
   - Triggers `onSectorEnterScript` when player is near

3. **SectorCleanupWorker** - Removes expired sectors
   - Deletes old sector instances
   - Frees up space for new ones

## Verification Checklist

After setup, verify:

- [ ] `/sector/encounter` returns encounters
- [ ] `/sector/instance` returns sector instances (may take a few minutes)
- [ ] `/script` includes all scripts from encounters
- [ ] `/prefab` includes all prefabs referenced by scripts
- [ ] Logs show no errors
- [ ] After entering a sector in-game, `/sector/instance/active` shows that sector
- [ ] Constructs appear in game at sector coordinates

## Getting Help

If issues persist:

1. **Check full logs:**

   ```bash
   docker-compose logs mod_dynamic_encounters > mod_logs.txt
   ```

2. **Export current state:**

   ```bash
   curl http://localhost:5480/sector/encounter > encounters.json
   curl http://localhost:5480/sector/instance > instances.json
   curl http://localhost:5480/script > scripts.json
   ```

3. **Check database directly:**
   ```sql
   SELECT COUNT(*) FROM mod_sector_encounter;
   SELECT COUNT(*) FROM mod_sector_instance;
   SELECT COUNT(*) FROM mod_faction_territory;
   ```
